<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Audio Signal Lab — Build · Record · Reconstruct</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="description" content="Interactive audio signal processing lab for exploring sampling, quantization, and reconstruction"/>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<header>
  <h1>Audio Signal Lab</h1>
  <p>Build an analog-like signal by combining waveforms, "record" it digitally with chosen sampling/bit depth and filters, then reconstruct it via DAC to hear and see the effects.</p>
</header>

<main>
  <!-- Enable Audio -->
  <section class="panel" id="gate">
    <h2>Enable Audio</h2>
    <div class="row">
      <button id="enableAudio">Click to Enable Audio</button>
      <span class="small">Browsers require a user gesture to start audio. Once enabled, you can play/stop in each step.</span>
    </div>
  </section>

  <!-- Audio Control Section -->
  <section class="panel" id="abToggleSection">
    <h2>Audio Control</h2>
    <div class="row inline">
      <div class="ab-toggle">
        <button id="abToggleA" class="active">A: Original</button>
        <button id="abToggleB">B: Processed</button>
      </div>
      <button id="abPlay" class="secondary">Play</button>
      <button id="abStop" class="ghost">Stop</button>
      <span class="small muted">Control all audio playback • A: Original signal • B: After DAC reconstruction</span>
    </div>
  </section>

  <!-- Step 1: Build the signal -->
  <section class="panel" id="step1">
    <h2>Step 1 — Build the Signal</h2>

    <div class="controls">
      <div class="row inline">
        <button id="addWave">+ Add waveform</button>
        <span class="spacer"></span>
        <span class="status" id="signalStatus">
          <span class="status-dot"></span>
          <span>Signal ready</span>
        </span>
        <span class="pill" id="ctxRate">Context: — Hz</span>
      </div>

      <div id="waves" class="grid"></div>

      <details id="s1More">
        <summary class="small">Advanced settings</summary>
        <div class="grid">
          <label>
            Preview Duration (s)
            <input type="number" id="previewDur" value="2.0" min="0.5" max="10" step="0.1">
          </label>
          <label>
            Master Gain
            <input type="range" id="masterGain" min="0" max="1" step="0.01" value="0.8">
          </label>
          <label style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="autoScaleToggle" checked style="width: auto;">
            <span>Auto-scale oscilloscope to waveform frequency</span>
          </label>
          <label>
            Spectrum Zoom
            <input type="range" id="spectrumZoom" min="1" max="10" step="0.5" value="1">
          </label>
        </div>
      </details>

      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <strong>Oscilloscope</strong>
            <span class="small muted">Time domain</span>
          </div>
          <canvas id="scope1" class="scope"></canvas>
        </div>
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <strong>Spectrum</strong>
            <span class="small muted">Magnitude (dB)</span>
          </div>
          <canvas id="spec1" class="scope"></canvas>
        </div>
      </div>

      <p class="small">
        <strong>Notes:</strong> Waveforms are band‑limited to prevent aliasing. Square and triangle waves include all harmonics up to 90% of Nyquist frequency with gentle roll-off. 
        The rounded appearance is intentional and correct - it's the sum of all harmonics that can be safely represented at your sample rate.
        Piano creates percussive strikes. Violin creates sustained bowed tones with vibrato.
      </p>
    </div>
  </section>

  <!-- Step 2: Recording / ADC -->
  <section class="panel" id="step2">
    <h2>Step 2 — Recording / ADC Simulation</h2>

    <div class="controls">
      <div class="grid">
        <label>
          Recording Sample Rate (Hz)
          <select id="recRate">
            <option>8000</option>
            <option>11025</option>
            <option>16000</option>
            <option>22050</option>
            <option selected>44100</option>
            <option>48000</option>
            <option>96000</option>
          </select>
        </label>
        <label>
          Bit Depth
          <select id="bitDepth">
            <option>8</option>
            <option selected>16</option>
            <option>24</option>
          </select>
        </label>
        <label>
          Channels
          <select id="channels">
            <option selected>Mono</option>
            <option>Stereo</option>
          </select>
        </label>
        <label>
          Duration to Simulate (s)
          <input type="number" id="recDur" value="2.0" min="0.5" max="10" step="0.1">
        </label>
      </div>

      <div class="grid">
        <label>
          Anti‑alias Filter
          <select id="aaKind">
            <option selected>None</option>
            <option>Low‑pass</option>
            <option>High‑pass</option>
          </select>
        </label>
        <label>
          Filter Cutoff (Hz)
          <input type="number" id="aaCutoff" value="18000" min="20" max="40000" step="10">
        </label>
        <label>
          Dither (TPDF)
          <select id="dither">
            <option selected>Off</option>
            <option>On</option>
          </select>
        </label>
        <label>
          Compression (Bonus)
          <select id="compression">
            <option selected>None (Linear PCM)</option>
            <option>μ‑law 8‑bit (G.711)</option>
          </select>
        </label>
      </div>

      <div class="row">
        <span class="status active">
          <span class="status-dot"></span>
          <span>Auto-recording enabled</span>
        </span>
        <span class="spacer"></span>
        <button id="downloadWav" disabled>Download WAV</button>
      </div>

      <div class="grid">
        <div class="card">
          <strong>Storage (uncompressed PCM)</strong>
          <div class="small">One minute at your settings:</div>
          <div id="size1min" class="mono" style="margin-top:6px;"></div>
        </div>
        <div class="card">
          <strong>Quantization Metrics</strong>
          <div class="small">Measured vs theoretical (full‑scale sine):</div>
          <div id="snrBox" class="mono" style="margin-top:6px;"></div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <strong>Sampling Visualization</strong>
            <span class="small muted">Points & quantization levels</span>
          </div>
          <label>
            Zoom
            <input type="range" id="samplingZoom" min="1" max="20" step="0.5" value="1">
          </label>
          <canvas id="samplingViz" class="scope tall"></canvas>
        </div>
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <strong>Recorded (quantized)</strong>
            <span class="small muted">Time domain</span>
          </div>
          <canvas id="scope2" class="scope"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <strong>Quantization Error</strong>
          <span class="small muted">x[n] − q[n]</span>
        </div>
        <canvas id="err2" class="scope"></canvas>
      </div>
    </div>
  </section>

  <!-- Step 3: DAC / restitution -->
  <section class="panel" id="step3">
    <h2>Step 3 — Reconstruction / DAC Simulation</h2>

    <div class="controls">
      <div class="grid">
        <label>
          DAC Method
          <select id="dacMethod">
            <option selected>Zero‑order hold (sample‑and‑hold)</option>
            <option>Linear interpolation</option>
          </select>
        </label>
        <label>
          Output Low‑pass (Hz, 0 = off)
          <input type="number" id="dacLP" value="18000" min="0" max="40000" step="10">
        </label>
        <label>
          Playback Gain
          <input type="range" id="dacGain" min="0" max="1" step="0.01" value="0.8">
        </label>
      </div>

      <div class="row">
        <span class="status" id="dacStatus">
          <span class="status-dot"></span>
          <span>DAC ready</span>
        </span>
      </div>

      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <strong>Reconstructed — Oscilloscope</strong>
            <span class="small muted">Time domain</span>
          </div>
          <canvas id="scope3" class="scope"></canvas>
        </div>
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <strong>Reconstructed — Spectrum</strong>
            <span class="small muted">Magnitude (dB)</span>
          </div>
          <canvas id="spec3" class="scope"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- Tips Section -->
  <section class="panel">
    <h2>Tips & Teaching Notes</h2>
    <ul class="small">
      <li><strong>Nyquist / aliasing:</strong> Try a high-frequency square wave, then reduce the recording sample rate or turn off anti‑alias filter. You'll hear/see aliasing artifacts.</li>
      <li><strong>Bit depth & SNR:</strong> Compare 8‑bit vs 16‑bit with and without TPDF dither. The measured SNR approaches ~<span class="mono">6.02·N + 1.76 dB</span> for a full‑scale sine.</li>
      <li><strong>μ‑law companding:</strong> Switch compression to <em>μ‑law 8‑bit</em> to hear higher resolution near zero and coarser steps at peaks.</li>
      <li><strong>DAC images:</strong> Use ZOH in Step 3 without output low‑pass to observe spectral "images"; then add the low‑pass to suppress them.</li>
      <li><strong>A/B comparison:</strong> After generating both input and output signals, use the A/B toggle to quickly switch between them and hear the differences.</li>
      <li><strong>Piano & Violin:</strong> Try the new instrument waveforms - piano creates percussive strikes while violin produces sustained bowed tones with natural vibrato.</li>
      <li><strong>Sampling visualization:</strong> Watch how sample rate and bit depth affect the digital representation - fewer samples and bits create a more "stepped" appearance.</li>
    </ul>
  </section>

  <!-- Footer -->
  <section class="panel" style="text-align: center; padding: 20px;">
    <p class="small muted">
      Audio Signal Lab · Interactive DSP Education Tool<br>
      Best experienced on desktop with headphones · Mobile optimized for learning on the go
    </p>
  </section>
</main>

<script type="module" src="js/main.js"></script>
</body>
</html>